<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Timetable - Face Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .content-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08);
            padding: 2rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        .content-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.12);
            border-color: #4b6cb7;
        }
        .timetable-grid {
            display: grid;
            grid-template-columns: auto repeat(6, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .timetable-header {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .time-slot {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
        }
        .timetable-cell {
            background: #fff;
            border: 2px solid #e9ecef;
            padding: 15px;
            border-radius: 10px;
            min-height: 120px;
            transition: all 0.3s ease;
        }
        .timetable-cell:hover {
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #4b6cb7;
        }
        .lecture-card {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .lecture-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .btn-add-lecture {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .btn-add-lecture:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .department-header {
            color: #182848;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        .department-subtitle {
            color: #4b6cb7;
            font-size: 1.1rem;
            margin-bottom: 0;
        }
        .form-select {
            border-radius: 10px;
            padding: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .form-select:focus {
            border-color: #4b6cb7;
            box-shadow: 0 0 0 0.2rem rgba(75, 108, 183, 0.25);
        }
        .modal-content {
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .modal-header {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
        }
        .modal-footer {
            border-radius: 0 0 20px 20px;
            padding: 1.5rem;
        }
        .btn-action {
            border-radius: 10px;
            padding: 8px 16px;
            transition: all 0.3s ease;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .timetable-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        .time-slot-header, .day-header {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }
        .time-slot {
            background: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-weight: 500;
            color: #495057;
        }
        .timetable-cell {
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 100px;
            vertical-align: middle;
        }
        .timetable-cell:hover {
            background-color: rgba(75, 108, 183, 0.1);
        }
        .lecture-card {
            background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 5px;
            position: relative;
        }
        .lecture-subject {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .lecture-faculty {
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        .lecture-unit {
            font-size: 0.8em;
            font-style: italic;
        }
        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 2px 6px;
            font-size: 0.8em;
            background: rgba(255, 255, 255, 0.2);
            border: none;
        }
        .delete-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-calendar-alt me-2"></i>
                Department Timetable Management
            </a>
            <div class="d-flex align-items-center">
                <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-action">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- Department Info -->
        <div class="content-card">
            <h3 class="department-header">
                <i class="fas fa-university me-2"></i>Department of {{ department }}
            </h3>
            <p class="department-subtitle">Manage your department's timetable</p>
        </div>

        <!-- Semester Selection -->
        <div class="content-card">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <select class="form-select" id="semesterSelect">
                        <option value="">Select Semester</option>
                        {% for semester in semesters %}
                        <option value="{{ semester }}">{{ semester }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-add-lecture" data-bs-toggle="modal" data-bs-target="#addLectureModal">
                        <i class="fas fa-plus me-2"></i>Add Lecture
                    </button>
                </div>
            </div>
        </div>

        <!-- Timetable Display -->
        <div class="content-card">
            <div id="timetableContainer">
                <div class="text-center py-5">
                    <i class="fas fa-calendar fa-3x text-muted mb-3"></i>
                    <h4>Select a semester to view timetable</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Lecture Modal -->
    <div class="modal fade" id="addLectureModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Lecture</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addLectureForm">
                        <div class="mb-3">
                            <label class="form-label">Day</label>
                            <select class="form-select" name="day" id="daySelect" required>
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                                <option value="Saturday">Saturday</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Time Slot</label>
                            <select class="form-select" name="time_slot" id="timeSlotSelect" required>
                                <option value="11:00-12:00">11:00-12:00</option>
                                <option value="12:00-13:00">12:00-13:00</option>
                                <option value="13:00-14:00">13:00-14:00</option>
                                <option value="14:00-15:00">14:00-15:00</option>
                                <option value="15:00-16:00">15:00-16:00</option>
                                <option value="16:00-17:00">16:00-17:00</option>
                                <option value="17:00-18:00">17:00-18:00</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subject</label>
                            <select class="form-select" name="subject" id="subjectSelect" required>
                                <option value="">Select Subject</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Faculty</label>
                            <select class="form-select" name="faculty_id" id="facultySelect" required>
                                <option value="">Select Faculty</option>
                                {% for faculty in faculty_members %}
                                <option value="{{ faculty.id }}">{{ faculty.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Unit</label>
                            <select class="form-select" name="unit" id="unitSelect" required>
                                <option value="">Select Unit</option>
                                <option value="Unit 1">Unit 1</option>
                                <option value="Unit 2">Unit 2</option>
                                <option value="Unit 3">Unit 3</option>
                                <option value="Unit 4">Unit 4</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary btn-action" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary btn-action" onclick="addLecture()">Add Lecture</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Define the days and time slots
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        const timeSlots = [
            '11:00-12:00',
            '12:00-13:00',
            '13:00-14:00',
            '14:00-15:00',
            '15:00-16:00',
            '16:00-17:00',
            '17:00-18:00'
        ];

        // Function to load subjects based on semester
        function loadSubjects(semester) {
            console.log('Loading subjects for semester:', semester);  // Debug log
            fetch(`/get-subjects/${semester}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Received subjects data:', data);  // Debug log
                    if (data.success) {
                        const subjectSelect = document.getElementById('subjectSelect');
                        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
                        data.subjects.forEach(subject => {
                            subjectSelect.innerHTML += `<option value="${subject.subject}">${subject.subject}</option>`;
                        });
                    } else {
                        console.error('Error loading subjects:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error loading subjects:', error);
                    alert('Error loading subjects. Please try again.');
                });
        }

        function createTimetableGrid() {
            const semester = document.getElementById('semesterSelect').value;
            if (!semester) return;

            // Load subjects when semester is selected
            loadSubjects(semester);

            const container = document.getElementById('timetableContainer');
            container.innerHTML = '';

            // Create table
            const table = document.createElement('table');
            table.className = 'table table-bordered timetable-table';

            // Create header row
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th class="time-slot-header">Time Slot</th>';
            days.forEach(day => {
                headerRow.innerHTML += `<th class="day-header">${day}</th>`;
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            // Create time slot rows
            const tbody = document.createElement('tbody');
            timeSlots.forEach(timeSlot => {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="time-slot">${timeSlot}</td>`;
                
                days.forEach(day => {
                    const cell = document.createElement('td');
                    cell.className = 'timetable-cell';
                    cell.setAttribute('data-day', day);
                    cell.setAttribute('data-time', timeSlot);
                    cell.onclick = () => showAddLectureModal(day, timeSlot);
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            container.appendChild(table);

            // Load existing timetable entries
            loadTimetable(semester);
        }

        function loadTimetable(semester) {
            fetch(`/get-timetable/${semester}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear existing entries
                        document.querySelectorAll('.timetable-cell').forEach(cell => {
                            cell.innerHTML = '';
                        });

                        // Add entries to the grid
                        data.timetable.forEach(entry => {
                            const cell = document.querySelector(
                                `.timetable-cell[data-day="${entry.day}"][data-time="${entry.time_slot}"]`
                            );
                            if (cell) {
                                cell.innerHTML = `
                                    <div class="lecture-card">
                                        <div class="lecture-subject">${entry.subject}</div>
                                        <div class="lecture-faculty">${entry.faculty_name}</div>
                                        <div class="lecture-unit">${entry.unit}</div>
                                        <button class="btn btn-sm btn-danger delete-btn" 
                                                onclick="deleteLecture(event, ${entry.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `;
                            }
                        });
                    }
                })
                .catch(error => console.error('Error loading timetable:', error));
        }

        function showAddLectureModal(day, timeSlot) {
            const semester = document.getElementById('semesterSelect').value;
            if (!semester) {
                alert('Please select a semester first');
                return;
            }

            // Load subjects for the selected semester
            loadSubjects(semester);

            // Set the day and time slot in the modal
            document.getElementById('daySelect').value = day;
            document.getElementById('timeSlotSelect').value = timeSlot;

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('addLectureModal'));
            modal.show();
        }

        function addLecture() {
            const semester = document.getElementById('semesterSelect').value;
            const form = document.getElementById('addLectureForm');
            const formData = new FormData(form);
            
            const data = {
                semester: semester,
                day: formData.get('day'),
                time_slot: formData.get('time_slot'),
                subject: formData.get('subject'),
                faculty_id: formData.get('faculty_id'),
                unit: formData.get('unit')
            };

            if (!data.semester || !data.day || !data.time_slot || !data.subject || !data.faculty_id || !data.unit) {
                alert('Please fill in all fields');
                return;
            }

            fetch('/add-timetable-entry', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addLectureModal'));
                    modal.hide();
                    loadTimetable(semester);
                } else {
                    alert(result.message);
                }
            })
            .catch(error => {
                console.error('Error adding lecture:', error);
                alert('Error adding lecture. Please try again.');
            });
        }

        function deleteLecture(event, lectureId) {
            event.stopPropagation();
            if (!confirm('Are you sure you want to delete this lecture?')) return;

            fetch(`/delete-timetable-entry/${lectureId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    const semester = document.getElementById('semesterSelect').value;
                    loadTimetable(semester);
                } else {
                    alert(result.message);
                }
            })
            .catch(error => {
                console.error('Error deleting lecture:', error);
                alert('Error deleting lecture. Please try again.');
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', () => {
            // Add change event listener to semester select
            const semesterSelect = document.getElementById('semesterSelect');
            semesterSelect.addEventListener('change', function() {
                createTimetableGrid();
                loadSubjects(this.value);  // Load subjects when semester changes
            });

            // Add change event listener to subject select
            const subjectSelect = document.getElementById('subjectSelect');
            subjectSelect.addEventListener('change', function() {
                console.log('Selected subject:', this.value);  // Debug log
            });
        });
    </script>
</body>
</html> 